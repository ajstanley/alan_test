<?php

function alan_test_menu() {
  $items['islandora/emic/collection'] = array(
    'page callback' => 'build_MADS',
    'type' => MENU_CALLBACK,
    'access callback' => 'user_access',
    'access arguments' => array(ISLANDORA_CRITICAL_EDITION_ADVANCED_READ),
  );
  return $items;
}

function build_mads() {
  $xml = new DomDocument('1.0', 'UTF-8');
  $xml->preserveWhiteSpace = false;
  $xml->formatOutput = true;
  $mads_uri = "http://www.loc.gov/mads/v2";
  //root.
  $root = $xml->createElementNS($mads_uri, 'mads:mads');
  $xml->appendChild($root);
  add_authority($xml, 'authority', "Some guy", '2012');
  add_authority($xml, 'variant', "Some other guy", '2014');

  $address = array(
    'street' => '123 Main Street',
    'city' => 'Charlottetown',
    'province' => 'PEI',
    'country' => 'Canada',
    'postcode' => 'C1A 2B3',
  );
  add_address($xml, $address);

  $affiliation = array(
    'position' => 'Digital Humanities Specialist',
    'start' => 'August 2013',
    'end' => 'Decembe 31, 2049',
  );
  add_affiliation($xml, $affiliation);
  return $xml->savexml();
}

function add_authority($xml, $type, $name, $date = NULL) {
  $mads_uri = "http://www.loc.gov/mads/v2";
  $root = $xml->documentElement;
  // authority.
  $authority = $xml->createElementNS($mads_uri, "mads:$type");
  $authority->setAttribute('geographicSubdivision', "not applicable");
  $root->appendChild($authority);
  // name.
  $name_node = $xml->createElementNS($mads_uri, 'mads:name');
  $name_node->setAttribute('type', 'personal');
  $authority->appendChild($name_node);
  //namePart
  $name_part = $xml->createElementNS($mads_uri, 'mads:namePart', $name);
  $name_node->appendChild($name_part);
  // date
  if ($date) {
    $name_date = $xml->createElementNS($mads_uri, 'mads:namePart', $date);
    $name_date->setAttribute('type', 'date');
    $name_node->appendChild($name_date);
  }
}

function add_address($xml, $address_values) {
  $mads_uri = "http://www.loc.gov/mads/v2";
  $root = $xml->documentElement;
  $affiliation = $xml->createElementNS($mads_uri, "mads:affiliation");
  $root->appendChild($affiliation);
  $address = $xml->createElementNS($mads_uri, "mads:address");
  $affiliation->appendChild($address);
  foreach ($address_values as $key => $value) {
    $line = $xml->createElementNS($mads_uri, "mads:$key", $value);
    $address->appendChild($line);
  }
}

function add_affiliation($xml, $affiliation_values) {
  if (!isset($affiliation_values['position'])) {
    return;
  }
  $mads_uri = "http://www.loc.gov/mads/v2";
  $root = $xml->documentElement;
  $affiliation = $xml->createElementNS($mads_uri, "mads:affiliation");
  $root->appendChild($affiliation);
  $position = $xml->createElementNS($mads_uri, "mads:position", $affiliation_values['position']);
  $affiliation->appendChild($position);
  $points = array('start', 'end');
  foreach ($points as $point) {
    if (isset($affiliation_values[$point])) {
      $line = $xml->createElementNS($mads_uri, "mads:dateValid", $affiliation_values[$point]);
      $line->setAttribute('point', $point);
      $affiliation->appendChild($line);
    }
  }
}